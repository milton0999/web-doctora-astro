---
import Layout from '../layouts/Layout.astro';
import ServicioCard from '../components/ServicioCard.astro';
import { getCollection } from 'astro:content';

// Obtener datos del sitio
const settings = await getCollection('settings');
const siteSettings = settings[0]?.data || {
  site_name: 'Centro M√©dico Gonzalitos',
  slogan: 'Cuidando tu salud con la mejor tecnolog√≠a y atenci√≥n humana',
  hero_image: null,
  whatsapp_number: '528115883775'
};

// Obtener servicios y promociones
const servicios = await getCollection('servicios');
const promotions = await getCollection('promotions');
const activePromotions = promotions.filter(p => 
  p.data.active && new Date(p.data.valid_until) > new Date()
);

// Servicios destacados
const featuredServices = servicios.filter(s => s.data.featured);
const regularServices = servicios.filter(s => !s.data.featured);
---

<Layout title="Inicio" description={siteSettings.description}>
    <!-- Alerta de Promociones -->
    {activePromotions.length > 0 && (
        <div class="promotion-alert alert alert-warning mb-0" role="alert">
            <div class="container text-center">
                üéâ {activePromotions.length} {activePromotions.length === 1 ? 'oferta especial' : 'ofertas especiales'} disponible{activePromotions.length === 1 ? '' : 's'} - 
                <a href="/promociones" class="alert-link fw-bold">Ver todas las promociones</a>
            </div>
        </div>
    )}
    
    <!-- Hero Section Avanzado -->
    {(() => {
        const heroConfig = siteSettings.hero || {};
        const heroButtons = heroConfig.buttons || {};
        
        // Determinar t√≠tulo y subt√≠tulo
        const heroTitle = heroConfig.title_override || siteSettings.site_name;
        const heroSubtitle = heroConfig.subtitle_override || siteSettings.slogan;
        
        // Obtener botones activos y ordenarlos
        const activeButtons = Object.entries(heroButtons)
            .filter(([key, button]: [string, any]) => button && button.enabled)
            .sort(([, a]: [string, any], [, b]: [string, any]) => (a?.order || 999) - (b?.order || 999));
        
        // Funci√≥n para generar enlace seg√∫n tipo de bot√≥n
        const getButtonLink = (buttonKey: string, button: any) => {
            switch(buttonKey) {
                case 'whatsapp':
                    return `https://wa.me/${siteSettings.whatsapp_number}?text=Hola, deseo agendar una cita`;
                case 'services':
                    return button.link || '#servicios';
                case 'emergency':
                    return button.link || `tel:${siteSettings.phone_number.replace(/\s/g, '')}`;
                default:
                    return '#';
            }
        };
        
        // Funci√≥n para generar clase CSS seg√∫n color
        const getButtonClass = (color: string) => {
            switch(color) {
                case 'primary': return 'btn-primary';
                case 'success': return 'btn-success';
                case 'outline-light': return 'btn-outline-light';
                case 'light':
                default: return 'btn-light';
            }
        };
        
        return (
            <header class={`hero-section py-5 hero-${heroConfig.background_style || 'gradient_blue'}`}>
                <style>
                    {heroConfig.background_style === 'solid_color' && `
                        .hero-section {
                            background: ${heroConfig.background_color || '#003da2'} !important;
                        }
                    `}
                    {heroConfig.background_style === 'gradient_green' && `
                        .hero-section {
                            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%) !important;
                        }
                    `}
                    {heroConfig.background_style === 'gradient_purple' && `
                        .hero-section {
                            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%) !important;
                        }
                    `}
                </style>
                <div class="container text-center py-5 position-relative">
                    {siteSettings.hero_image ? (
                        <img src={siteSettings.hero_image} alt={heroTitle} class="hero-image mb-4" style="max-height: 400px; border-radius: 20px;" />
                    ) : (
                        <h1 class="display-3 fw-bold text-white mb-4">{heroTitle}</h1>
                    )}
                    <p class="lead text-white mb-4">{heroSubtitle}</p>
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        {activeButtons.map(([buttonKey, button]: [string, any]) => (
                            <a href={getButtonLink(buttonKey, button)} 
                               class={`btn btn-lg fw-bold ${getButtonClass(button?.color || 'light')}`}
                               target={buttonKey === 'whatsapp' || buttonKey === 'emergency' ? '_blank' : '_self'}
                               rel={buttonKey === 'whatsapp' || buttonKey === 'emergency' ? 'noopener noreferrer' : ''}>
                                {button?.emoji || ''} {button?.text || ''}
                            </a>
                        ))}
                    </div>
                </div>
            </header>
        );
    })()}

    <!-- Servicios Destacados -->
    {featuredServices.length > 0 && (
        <section class="py-5 featured-services">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="display-5 fw-bold text-primary mb-3">‚≠ê Servicios Destacados</h2>
                    <p class="lead text-muted mb-4">Los estudios m√°s solicitados en nuestro centro m√©dico</p>
                </div>
                <div class="row g-4 justify-content-center">
                    {featuredServices.map(servicio => (
                        <div class="col-sm-12 col-md-6 col-lg-4">
                            <ServicioCard servicio={servicio} />
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- Todos los Servicios -->
    <section id="servicios" class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-5 fw-bold text-primary mb-3">üè• Todos Nuestros Estudios</h2>
                <p class="lead text-muted mb-4">Ofrecemos una amplia gama de servicios m√©dicos de alta calidad</p>
            </div>
            <div class="row g-4">
                {regularServices.map(servicio => (
                    <div class="col-sm-12 col-md-6 col-lg-4">
                        <ServicioCard servicio={servicio} />
                    </div>
                ))}
            </div>
            
            {servicios.length === 0 && (
                <div class="text-center py-5">
                    <h3 class="text-muted">Pronto tendremos nuestros servicios disponibles</h3>
                    <p class="text-muted">Mientras tanto, puedes contactarnos directamente</p>
                    <a href={`https://wa.me/${siteSettings.whatsapp_number}`} class="btn btn-primary" target="_blank">
                        üí¨ Contactar por WhatsApp
                    </a>
                </div>
            )}
        </div>
    </section>

    <!-- CTA Section -->
    <section class="py-5 cta-section">
        <div class="container text-center py-5">
            <h2 class="display-5 fw-bold text-white mb-4">¬øListo para tu estudio m√©dico?</h2>
            <p class="lead text-white mb-5">Agenda tu cita hoy mismo y recibe la mejor atenci√≥n m√©dica con tecnolog√≠a de vanguardia</p>
            <div class="d-flex justify-content-center gap-4">
                <a href={`https://wa.me/${siteSettings.whatsapp_number}?text=Hola, deseo agendar una cita`}
                   class="btn btn-light btn-lg fw-bold px-4" target="_blank">
                    üí¨ Agendar Ahora
                </a>
                <a href="/contacto" class="btn btn-outline-light btn-lg fw-bold px-4">
                    üìû M√°s Informaci√≥n
                </a>
            </div>
        </div>
    </section>
</Layout>

<style>
.hero-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 50%, #1e1b4b 100%);
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.hero-image {
    box-shadow: var(--shadow-xl);
    border-radius: 20px;
    transition: transform 0.3s ease;
}

.hero-image:hover {
    transform: scale(1.02);
}

.promotion-alert {
    border-radius: 0;
    margin-bottom: 0;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
}

.btn-light {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: var(--text-dark);
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-light:hover {
    background: var(--bg-white);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-outline-light {
    border: 2px solid rgba(255, 255, 255, 0.8);
    color: var(--bg-white);
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--bg-white);
    color: var(--bg-white);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.featured-services {
    background: linear-gradient(135deg, var(--bg-light) 0%, #f1f5f9 100%);
}

.cta-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 50%, #1e1b4b 100%);
    position: relative;
    overflow: hidden;
}

.cta-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

@media (max-width: 768px) {
    .hero-section {
        padding: 3rem 0;
    }

    .display-3 {
        font-size: 2.2rem;
        line-height: 1.2;
    }

    .display-5 {
        font-size: 1.6rem;
        line-height: 1.3;
    }

    .d-flex.gap-3 {
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-md) !important;
    }

    .btn-lg {
        width: 100%;
        max-width: 320px;
        padding: var(--spacing-lg) var(--spacing-xl);
        font-size: 1.1rem;
    }

    .hero-section::before {
        background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 50%);
    }
}
</style>