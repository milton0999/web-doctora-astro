---
import Layout from '../layouts/Layout.astro';
import ServicioCard from '../components/ServicioCard.astro';
import CTASection from '../components/CTASection.astro';
import WhatsAppButton from '../components/WhatsAppButton.astro';
import { getCollection } from 'astro:content';

// Obtener datos del sitio
const settings = await getCollection('settings');
const siteSettings = settings[0]?.data || {
  site_name: 'Centro M√©dico Gonzalitos',
  slogan: 'Cuidando tu salud con la mejor tecnolog√≠a y atenci√≥n humana',
  hero_image: null,
  whatsapp_number: '528115883775'
};

// Obtener servicios y promociones
const servicios = await getCollection('servicios');
const promotions = await getCollection('promotions');
const activePromotions = promotions.filter(p => 
  p.data.active && new Date(p.data.valid_until) > new Date()
);

// Servicios destacados
const featuredServices = servicios.filter(s => s.data.featured);
const regularServices = servicios.filter(s => !s.data.featured);

// Agrupar servicios por categor√≠a para filtrado
const serviciosPorCategoria = {
  adultos: servicios.filter(s => s.data.categoria === 'Adulto'),
  embarazadas: servicios.filter(s => s.data.categoria === 'Embarazada'),
  pediatrico: servicios.filter(s => s.data.categoria === 'Pediatrico')
};
---

<Layout title="Inicio" description={siteSettings.description}>
    <!-- Alerta de Promociones -->
    {activePromotions.length > 0 && (
        <div class="promotion-alert alert alert-warning mb-0" role="alert">
            <div class="container text-center">
                üéâ {activePromotions.length} {activePromotions.length === 1 ? 'oferta especial' : 'ofertas especiales'} disponible{activePromotions.length === 1 ? '' : 's'} - 
                <a href="/promociones" class="alert-link fw-bold">Ver todas las promociones</a>
            </div>
        </div>
    )}
    
    <!-- Hero Section Avanzado -->
    {(() => {
        const heroConfig = siteSettings.hero || {};
        const heroButtons = heroConfig.buttons || {};
        
        // Determinar t√≠tulo y subt√≠tulo
        const heroTitle = heroConfig.title_override || siteSettings.site_name;
        const heroSubtitle = heroConfig.subtitle_override || siteSettings.slogan;
        
        // Obtener botones activos y ordenarlos
        const activeButtons = Object.entries(heroButtons)
            .filter(([key, button]: [string, any]) => button && button.enabled)
            .sort(([, a]: [string, any], [, b]: [string, any]) => (a?.order || 999) - (b?.order || 999));
        
        // Funci√≥n para generar enlace seg√∫n tipo de bot√≥n
        const getButtonLink = (buttonKey: string, button: any) => {
            switch(buttonKey) {
                case 'whatsapp':
                    return `https://wa.me/${siteSettings.whatsapp_number}?text=Hola, deseo agendar una cita`;
                case 'services':
                    return button.link || '#servicios';
                case 'emergency':
                    return button.link || `tel:${siteSettings.phone_number.replace(/\s/g, '')}`;
                default:
                    return '#';
            }
        };
        
        // Funci√≥n para generar clase CSS seg√∫n color
        const getButtonClass = (color: string) => {
            switch(color) {
                case 'primary': return 'btn-primary';
                case 'success': return 'btn-success';
                case 'outline-light': return 'btn-outline-light';
                case 'light':
                default: return 'btn-light';
            }
        };
        
        return (
            <header class={`hero-section py-5 hero-${heroConfig.background_style || 'gradient_blue'}`}>
                <style>
                    {heroConfig.background_style === 'solid_color' && `
                        .hero-section {
                            background: ${heroConfig.background_color || '#003da2'} !important;
                        }
                    `}
                    {heroConfig.background_style === 'gradient_green' && `
                        .hero-section {
                            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%) !important;
                        }
                    `}
                    {heroConfig.background_style === 'gradient_purple' && `
                        .hero-section {
                            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%) !important;
                        }
                    `}
                </style>
                <div class="container text-center py-5 position-relative">
                    {siteSettings.hero_image ? (
                        <img src={siteSettings.hero_image} alt={heroTitle} class="hero-image mb-4" style="max-height: 400px; border-radius: 20px; background-color: white; padding: 10px;" />
                    ) : (
                        <h1 class="display-3 fw-bold text-white mb-4">{heroTitle}</h1>
                    )}
                    <p class="lead text-white mb-4">{heroSubtitle}</p>
                    <p class="text-white small mb-4">üìç Ubicados en Gonzalitos, Monterrey - Atenci√≥n m√©dica de calidad para toda la familia</p>
                    
                    <!-- Trust Indicators -->
                    <div class="trust-indicators mb-4">
                        <div class="d-flex justify-content-center gap-3 flex-wrap">
                            <div class="trust-item">
                                <i class="fas fa-award text-warning me-2"></i>
                                <span class="text-white small fw-medium">10+ A√±os</span>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-users text-warning me-2"></i>
                                <span class="text-white small fw-medium">5,000+ Pacientes</span>
                            </div>
                            <div class="trust-item">
                                <i class="fas fa-certificate text-warning me-2"></i>
                                <span class="text-white small fw-medium">Certificados</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-center gap-3 flex-wrap">
                        {activeButtons.map(([buttonKey, button]: [string, any]) => {
                            if (buttonKey === 'whatsapp') {
                                return <WhatsAppButton variant="cta" text={`${button?.emoji || ''} ${button?.text || ''}`} message="Hola, deseo agendar una cita" />;
                            } else {
                                return (
                                    <a href={getButtonLink(buttonKey, button)} 
                                       class={`btn btn-lg fw-bold ${getButtonClass(button?.color || 'light')}`}
                                       target={buttonKey === 'emergency' ? '_blank' : '_self'}
                                       rel={buttonKey === 'emergency' ? 'noopener noreferrer' : ''}>
                                        {button?.emoji || ''} {button?.text || ''}
                                    </a>
                                );
                            }
                        })}
                    </div>
                </div>
            </header>
        );
    })()}

    <!-- Servicios Destacados -->
    {featuredServices.length > 0 && (
        <section class="py-5 featured-services">
            <div class="container">
                <div class="text-center mb-5">
                    <h2 class="display-5 fw-bold text-primary mb-3">‚≠ê Servicios Destacados</h2>
                    <p class="lead text-muted mb-4">Los estudios m√°s solicitados en nuestro centro m√©dico</p>
                </div>
                <div class="row g-4 justify-content-center">
                    {featuredServices.map(servicio => (
                        <div class="col-sm-12 col-md-6 col-lg-4">
                            <ServicioCard servicio={servicio} />
                        </div>
                    ))}
                </div>
            </div>
        </section>
    )}

    <!-- Todos los Servicios con Filtrado -->
    <section id="servicios" class="py-5">
        <div class="container">
            <div class="text-center mb-5">
                <h2 class="display-5 fw-bold text-primary mb-3">üè• Nuestros Estudios</h2>
                <p class="lead text-muted mb-4">Filtra por categor√≠a para encontrar tu estudio r√°pidamente</p>
            </div>
            
            <!-- Category Filter Buttons -->
            <div class="text-center mb-5">
                <div class="d-inline-flex gap-2 flex-wrap justify-content-center">
                    <button class="category-btn active" data-category="all" onclick="filterServices('all')" type="button" aria-pressed="true">
                        Todos ({servicios.length})
                    </button>
                    <button class="category-btn" data-category="Adulto" onclick="filterServices('Adulto')" type="button" aria-pressed="false">
                        Adulto ({serviciosPorCategoria?.adultos?.length || 0})
                    </button>
                    <button class="category-btn" data-category="Embarazada" onclick="filterServices('Embarazada')" type="button" aria-pressed="false">
                        Embarazada ({serviciosPorCategoria?.embarazadas?.length || 0})
                    </button>
                    <button class="category-btn" data-category="Pediatrico" onclick="filterServices('Pediatrico')" type="button" aria-pressed="false">
                        Pediatr√≠a ({serviciosPorCategoria?.pediatrico?.length || 0})
                    </button>
                    <button class="category-btn" data-category="Cardiologia" onclick="filterServices('Cardiologia')" type="button" aria-pressed="false">
                        Cardiolog√≠a ({servicios.filter(s => s.data.categoria === 'Cardiologia').length})
                    </button>
                    <button class="category-btn" data-category="Doppler" onclick="filterServices('Doppler')" type="button" aria-pressed="false">
                        Doppler ({servicios.filter(s => s.data.categoria === 'Doppler').length})
                    </button>
                    <button class="category-btn" data-category="Tiroides" onclick="filterServices('Tiroides')" type="button" aria-pressed="false">
                        Tiroides ({servicios.filter(s => s.data.categoria === 'Tiroides').length})
                    </button>
                    <button class="category-btn" data-category="Mama" onclick="filterServices('Mama')" type="button" aria-pressed="false">
                        Mama ({servicios.filter(s => s.data.categoria === 'Mama').length})
                    </button>
                    <button class="category-btn" data-category="Musculoesqueletico" onclick="filterServices('Musculoesqueletico')" type="button" aria-pressed="false">
                        Musculoesquel√©tico ({servicios.filter(s => s.data.categoria === 'Musculoesqueletico').length})
                    </button>
                </div>
            </div>
            
            <!-- Services Grid -->
            <div class="row g-4" id="servicesGrid">
                {regularServices.map(servicio => (
                    <div class="col-sm-12 col-md-6 col-lg-4 service-item" data-category={servicio.data.categoria}>
                        <ServicioCard servicio={servicio} />
                    </div>
                ))}
            </div>
            
            {servicios.length === 0 && (
                <div class="text-center py-5">
                    <h3 class="text-muted">Pronto tendremos nuestros servicios disponibles</h3>
                    <p class="text-muted">Mientras tanto, puedes contactarnos directamente</p>
                    <WhatsAppButton 
                        variant="inline"
                        message="Hola, deseo agendar una cita"
                    />
                </div>
            )}
        </div>
    </section>

    <!-- Enhanced CTA Section with CMS Management -->
    <CTASection settings={settings[0]} showOn={['home']} />
</Layout>

<style>
/* Trust Indicators */
.trust-indicators {
    opacity: 0.9;
    backdrop-filter: blur(10px);
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 15px;
    margin: 15px 0;
}

.trust-item {
    display: flex;
    align-items: center;
    transition: transform 0.3s ease;
    padding: 6px 12px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.1);
}

.trust-item:hover {
    transform: translateY(-2px);
    background: rgba(255, 255, 255, 0.15);
}

.hero-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 50%, #1e1b4b 100%);
    position: relative;
    overflow: hidden;
}

.hero-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

.hero-image {
    background-color: white;
    padding: 10px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15), 0 10px 20px rgba(0,0,0,0.1);
    border-radius: 20px;
    transition: all 0.3s ease;
}

.hero-image:hover {
    transform: scale(1.02);
    box-shadow: 0 25px 50px rgba(0,0,0,0.2), 0 15px 25px rgba(0,0,0,0.15);
}

/* Service Filter Buttons */
.category-btn {
    background: var(--bg-light);
    border: 2px solid var(--border-color);
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
    font-size: 0.9rem;
    box-shadow: var(--shadow-sm);
}

.category-btn:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.category-btn.active {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    box-shadow: var(--shadow-md);
}

.service-item.hidden {
    display: none;
}

.promotion-alert {
    border-radius: 0;
    margin-bottom: 0;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    border: none;
}

.btn-light {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
    color: var(--text-dark);
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-light:hover {
    background: var(--bg-white);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-outline-light {
    border: 2px solid rgba(255, 255, 255, 0.8);
    color: var(--bg-white);
    font-weight: 600;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.btn-outline-light:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: var(--bg-white);
    color: var(--bg-white);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

.featured-services {
    background: linear-gradient(135deg, var(--bg-light) 0%, #f1f5f9 100%);
}

.cta-section {
    background: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 50%, #1e1b4b 100%);
    position: relative;
    overflow: hidden;
}

.cta-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}

@media (max-width: 768px) {
    .hero-section {
        padding: 3rem 0;
    }

    .display-3 {
        font-size: 2.2rem;
        line-height: 1.2;
    }

    .display-5 {
        font-size: 1.6rem;
        line-height: 1.3;
    }

    .d-flex.gap-3 {
        flex-direction: column;
        align-items: center;
        gap: var(--spacing-md) !important;
    }

    .btn-lg {
        width: 100%;
        max-width: 320px;
        padding: var(--spacing-lg) var(--spacing-xl);
        font-size: 1.1rem;
    }

    .hero-section::before {
        background: radial-gradient(circle at 50% 50%, rgba(255,255,255,0.05) 0%, transparent 50%);
    }
    
    /* Responsive adjustments for filter buttons */
    .category-btn {
        font-size: 0.8rem;
        padding: 8px 16px;
    }
}

/* Enhanced CTA Styles */
.urgency-badge {
    background: rgba(239, 68, 68, 0.9);
    color: white;
    padding: 8px 20px;
    border-radius: 25px;
    font-weight: 600;
    animation: pulse 2s infinite;
    display: inline-block;
    backdrop-filter: blur(10px);
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.trust-pill {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 6px 16px;
    border-radius: 20px;
    color: white;
    font-size: 0.9rem;
    transition: all 0.3s ease;
}

.trust-pill:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
}

.enhanced-cta-section {
    position: relative;
    overflow: hidden;
}

.enhanced-cta-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: radial-gradient(circle at 30% 70%, rgba(255,255,255,0.1) 0%, transparent 50%);
    pointer-events: none;
}
</style>

<script>
function filterServices(category) {
    // Remove active class and update ARIA from all buttons
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
    });
    
    // Add active class and update ARIA to clicked button
    const activeBtn = document.querySelector(`[data-category="${category}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.setAttribute('aria-pressed', 'true');
    }
    
    // Filter services
    const serviceItems = document.querySelectorAll('.service-item');
    let visibleCount = 0;
    
    serviceItems.forEach(item => {
        const itemCategory = item.getAttribute('data-category');
        
        if (category === 'all' || itemCategory === category) {
            item.classList.remove('hidden');
            visibleCount++;
        } else {
            item.classList.add('hidden');
        }
    });
    
    // Announce to screen readers
    const announcement = document.createElement('div');
    announcement.setAttribute('role', 'status');
    announcement.setAttribute('aria-live', 'polite');
    announcement.className = 'sr-only';
    announcement.textContent = `Mostrando ${visibleCount} servicio${visibleCount !== 1 ? 's' : ''}`;
    document.body.appendChild(announcement);
    
    setTimeout(() => announcement.remove(), 1000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Trust items animation on scroll
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    });
    
    document.querySelectorAll('.trust-item').forEach(item => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        item.style.transition = 'all 0.6s ease';
        observer.observe(item);
    });
});
</script>